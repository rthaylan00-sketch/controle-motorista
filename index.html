<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Controle Pro Motorista</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --green: #00c853;
  --green-dim: rgba(0,200,83,0.12);
  --green-border: rgba(0,200,83,0.2);
  --bg: #080c08;
  --s1: #101510;
  --s2: #141a14;
  --s3: #1a221a;
  --text: #eef4ee;
  --muted: #5a705a;
  --red: #ff4757;
  --red-dim: rgba(255,71,87,0.12);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

.topbar {
position:sticky; top:0; z-index:50;
background:rgba(8,12,8,0.92); backdrop-filter:blur(12px);
border-bottom:1px solid var(--green-border);
padding:14px 20px;
display:flex; align-items:center; justify-content:space-between;
}
.topbar-brand { font-family:'Syne',sans-serif; font-size:17px; font-weight:800; display:flex; align-items:center; gap:10px; }
.brand-dot { width:8px; height:8px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.4)} }
.topbar-right { display:flex; align-items:center; gap:10px; }
.user-chip { background:var(--s2); border:1px solid var(--green-border); border-radius:20px; padding:6px 12px 6px 8px; display:flex; align-items:center; gap:8px; font-size:13px; font-weight:500; }
.user-av { width:26px; height:26px; border-radius:50%; background:var(--green); color:#000; display:flex; align-items:center; justify-content:center; font-family:'Syne',sans-serif; font-size:11px; font-weight:800; }
.btn-logout { background:none; border:1px solid var(--green-border); color:var(--muted); border-radius:8px; padding:6px 11px; font-size:12px; cursor:pointer; font-family:'DM Sans',sans-serif; transition:all .2s; }
.btn-logout:hover { border-color:var(--red); color:var(--red); }

.page { max-width:480px; margin:0 auto; padding:20px 16px 48px; }

.hero { background:linear-gradient(135deg,#003d18 0%,#006b2a 50%,#009935 100%); border-radius:22px; padding:24px 22px; margin-bottom:16px; position:relative; overflow:hidden; animation:fadeUp .4s ease both; }
.hero::before { content:''; position:absolute; top:-40px; right:-40px; width:160px; height:160px; border-radius:50%; background:rgba(255,255,255,.04); }
.hero::after  { content:''; position:absolute; bottom:-60px; right:20px; width:200px; height:200px; border-radius:50%; background:rgba(255,255,255,.03); }
.hero-label { font-size:11px; font-weight:500; opacity:.7; text-transform:uppercase; letter-spacing:.8px; margin-bottom:6px; }
.hero-value { font-family:'Syne',sans-serif; font-size:38px; font-weight:800; color:#000; line-height:1; }
.hero-sub { font-size:12px; opacity:.7; margin-top:8px; }
.hero-icon { position:absolute; right:22px; top:22px; font-size:32px; opacity:.6; }

.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.stat { background:var(--s1); border:1px solid var(--green-border); border-radius:16px; padding:16px; animation:fadeUp .4s ease both; }
.stat:nth-child(1){animation-delay:.05s} .stat:nth-child(2){animation-delay:.1s}
.stat:nth-child(3){animation-delay:.15s} .stat:nth-child(4){animation-delay:.2s}
.stat-lbl { font-size:10px; text-transform:uppercase; letter-spacing:.6px; color:var(--muted); font-weight:500; margin-bottom:7px; }
.stat-val { font-family:'Syne',sans-serif; font-size:20px; font-weight:700; }
.stat-val.g { color:var(--green); } .stat-val.r { color:var(--red); }

.card { background:var(--s1); border:1px solid var(--green-border); border-radius:20px; padding:22px; margin-bottom:16px; animation:fadeUp .4s .25s ease both; }
.card-title { font-family:'Syne',sans-serif; font-size:15px; font-weight:800; margin-bottom:18px; display:flex; align-items:center; gap:8px; }
.card-title-bar { width:3px; height:16px; background:var(--green); border-radius:2px; }
.fields-2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.field { margin-bottom:12px; }
.field label { display:block; font-size:10px; font-weight:500; text-transform:uppercase; letter-spacing:.6px; color:var(--muted); margin-bottom:7px; }
.field input { width:100%; padding:13px 14px; background:var(--s2); border:1px solid var(--green-border); border-radius:11px; color:var(--text); font-size:15px; font-family:'DM Sans',sans-serif; outline:none; transition:border-color .2s, background .2s; }
.field input:focus { border-color:var(--green); background:var(--s3); }
.field input::placeholder { color:var(--muted); }
.btn-save { width:100%; padding:15px; background:var(--green); color:#000; border:none; border-radius:13px; font-family:'Syne',sans-serif; font-size:15px; font-weight:800; cursor:pointer; transition:all .2s; margin-top:4px; display:flex; align-items:center; justify-content:center; gap:6px; }
.btn-save:hover { background:#00e563; transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,200,83,.3); }
.btn-save:active { transform:translateY(0); }
.btn-save:disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }

.filter-row { display:flex; gap:8px; margin-bottom:14px; flex-wrap:wrap; }
.filter-btn { padding:7px 14px; border:1px solid var(--green-border); background:var(--s1); color:var(--muted); border-radius:20px; font-size:12px; cursor:pointer; transition:all .2s; font-family:'DM Sans',sans-serif; font-weight:500; }
.filter-btn.active { background:var(--green); border-color:var(--green); color:#000; font-weight:700; }

.hist-card { background:var(--s1); border:1px solid var(--green-border); border-radius:20px; overflow:hidden; animation:fadeUp .4s .3s ease both; }
.hist-list { max-height:440px; overflow-y:auto; }
.hist-list::-webkit-scrollbar { width:3px; }
.hist-list::-webkit-scrollbar-thumb { background:var(--green-border); border-radius:2px; }
.hist-item { padding:15px 20px; border-bottom:1px solid rgba(255,255,255,.04); display:flex; align-items:center; justify-content:space-between; transition:background .15s; }
.hist-item:last-child { border-bottom:none; }
.hist-item:hover { background:var(--s2); }
.hi-date { font-size:11px; color:var(--muted); margin-bottom:3px; }
.hi-net { font-family:'Syne',sans-serif; font-size:17px; font-weight:700; }
.hi-net.pos { color:var(--green); } .hi-net.neg { color:var(--red); }
.hi-tags { display:flex; gap:6px; margin-top:5px; flex-wrap:wrap; }
.tag { background:var(--s2); border:1px solid var(--green-border); border-radius:6px; padding:2px 8px; font-size:10px; color:var(--muted); font-weight:500; }
.hi-right { display:flex; align-items:center; gap:8px; text-align:right; }
.hi-vals { font-size:12px; color:var(--muted); line-height:1.8; }
.btn-del { background:none; border:none; cursor:pointer; color:var(--muted); font-size:15px; padding:4px; transition:color .2s; border-radius:6px; }
.btn-del:hover { color:var(--red); background:var(--red-dim); }
.empty { padding:52px 20px; text-align:center; color:var(--muted); }
.empty-icon { font-size:44px; margin-bottom:12px; opacity:.4; }
.empty-text { font-size:14px; }
.loading { display:flex; align-items:center; justify-content:center; padding:48px; color:var(--muted); gap:12px; font-size:14px; }
.spin { width:20px; height:20px; border:2px solid var(--green-border); border-top-color:var(--green); border-radius:50%; animation:spin .7s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }

.toast { position:fixed; bottom:28px; left:50%; transform:translateX(-50%) translateY(80px); padding:13px 22px; border-radius:12px; font-family:'Syne',sans-serif; font-size:13px; font-weight:700; z-index:999; white-space:nowrap; pointer-events:none; transition:transform .35s cubic-bezier(.34,1.56,.64,1); }
.toast.show { transform:translateX(-50%) translateY(0); }
.toast.ok { background:var(--green); color:#000; }
.toast.err { background:var(--red); color:#fff; }

.sect-title { font-family:'Syne',sans-serif; font-size:15px; font-weight:800; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.sect-title::before { content:''; display:block; width:3px; height:16px; background:var(--green); border-radius:2px; }

@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-brand">
    <div class="brand-dot"></div>
    Controle Pro
  </div>
  <div class="topbar-right">
    <div class="user-chip">
      <div class="user-av" id="userAv">?</div>
      <span id="userName">...</span>
    </div>
    <button class="btn-logout" onclick="logout()">Sair</button>
  </div>
</div>

<div class="page">

  <div class="hero">
    <div class="hero-icon">üíµ</div>
    <div class="hero-label">Lucro l√≠quido do m√™s</div>
    <div class="hero-value" id="heroNet">R$ 0,00</div>
    <div class="hero-sub" id="heroSub">Calculando...</div>
  </div>

  <div class="stats-grid">
    <div class="stat"><div class="stat-lbl">üí∞ Ganhos hoje</div><div class="stat-val g" id="stTodayInc">R$ 0</div></div>
    <div class="stat"><div class="stat-lbl">‚õΩ Gastos hoje</div><div class="stat-val r" id="stTodayExp">R$ 0</div></div>
    <div class="stat"><div class="stat-lbl">üìÖ Ganhos m√™s</div><div class="stat-val g" id="stMonthInc">R$ 0</div></div>
    <div class="stat"><div class="stat-lbl">üõ£Ô∏è KM m√™s</div><div class="stat-val" id="stMonthKm">0 km</div></div>
  </div>

  <div class="card">
    <div class="card-title"><div class="card-title-bar"></div> Registrar Dia</div>
    <div class="fields-2">
      <div class="field"><label>üí∞ Ganhos R$</label><input type="number" id="ganho" placeholder="0,00" min="0" step="0.01"></div>
      <div class="field"><label>‚õΩ Gastos R$</label><input type="number" id="gasto" placeholder="0,00" min="0" step="0.01"></div>
    </div>
    <div class="fields-2">
      <div class="field"><label>üõ£Ô∏è KM rodados</label><input type="number" id="km" placeholder="0" min="0"></div>
      <div class="field"><label>üìÖ Data</label><input type="date" id="data"></div>
    </div>
    <button class="btn-save" id="btnSave" onclick="salvar()">‚úì &nbsp;Salvar Dia</button>
  </div>

  <div class="sect-title">Hist√≥rico</div>
  <div class="filter-row">
    <button class="filter-btn active" onclick="setFiltro('todos',this)">Todos</button>
    <button class="filter-btn" onclick="setFiltro('mes',this)">Este m√™s</button>
    <button class="filter-btn" onclick="setFiltro('semana',this)">Esta semana</button>
  </div>
  <div class="hist-card">
    <div class="hist-list" id="histList">
      <div class="loading"><div class="spin"></div> Carregando...</div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp }     from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
                              from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, addDoc, getDocs, deleteDoc, query, orderBy, Timestamp }
                              from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBHfI8CE9eMUQ99JM_XAjEkiuFMDoz3M8I",
  authDomain: "controle-pro-motorista.firebaseapp.com",
  projectId: "controle-pro-motorista",
  storageBucket: "controle-pro-motorista.appspot.com",
  messagingSenderId: "991201688036",
  appId: "1:991201688036:web:fac529d7c0e7cad826eff1"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

let uid = null;
let allEntries = [];
let filtroAtual = 'todos';

onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = './login.html'; return; }
  uid = user.uid;

  const snap = await getDoc(doc(db, 'usuarios', uid));
  const nome = snap.exists() ? snap.data().nome : user.email.split('@')[0];
  document.getElementById('userName').textContent = nome.split(' ')[0];
  document.getElementById('userAv').textContent   = nome[0].toUpperCase();
  document.getElementById('data').value = hoje();

  await carregarDados();
});

window.logout = async () => { await signOut(auth); window.location.href = './login.html'; };

function hoje() { return new Date().toISOString().split('T')[0]; }
function fmt(v) { return 'R$ ' + (v||0).toLocaleString('pt-BR', {minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmtDate(str) { if (!str) return ''; const [y,m,d] = str.split('-'); return `${d}/${m}/${y}`; }
function showToast(msg, type='ok') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 2600);
}

window.salvar = async () => {
  if (!uid) return;
  const ganho = parseFloat(document.getElementById('ganho').value) || 0;
  const gasto = parseFloat(document.getElementById('gasto').value) || 0;
  const km    = parseFloat(document.getElementById('km').value)    || 0;
  const data  = document.getElementById('data').value;
  if (!data) { showToast('Selecione uma data!', 'err'); return; }

  const btn = document.getElementById('btnSave');
  btn.disabled = true; btn.textContent = 'Salvando...';

  try {
    const ref = collection(db, 'usuarios', uid, 'dias');
    const docRef = await addDoc(ref, { data, ganho, gasto, km, lucro: ganho - gasto, criadoEm: Timestamp.now() });
    allEntries.unshift({ id: docRef.id, data, ganho, gasto, km, lucro: ganho - gasto });
    document.getElementById('ganho').value = '';
    document.getElementById('gasto').value = '';
    document.getElementById('km').value    = '';
    document.getElementById('data').value  = hoje();
    atualizarUI();
    showToast('‚úì Dia salvo com sucesso!');
  } catch(e) {
    console.error(e);
    showToast('Erro ao salvar. Tente novamente.', 'err');
  }
  btn.disabled = false; btn.innerHTML = '‚úì &nbsp;Salvar Dia';
};

window.excluir = async (id) => {
  if (!confirm('Excluir este registro?')) return;
  try {
    await deleteDoc(doc(db, 'usuarios', uid, 'dias', id));
    allEntries = allEntries.filter(e => e.id !== id);
    atualizarUI();
    showToast('üóë Registro removido');
  } catch(e) { showToast('Erro ao excluir.', 'err'); }
};

async function carregarDados() {
  const q = query(collection(db, 'usuarios', uid, 'dias'), orderBy('data', 'desc'));
  const snap = await getDocs(q);
  allEntries = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  atualizarUI();
}

function atualizarUI() { atualizarStats(); renderHistorico(); }

function atualizarStats() {
  const hj     = hoje();
  const mesStr = hj.slice(0,7);
  const dHoje  = allEntries.filter(e => e.data === hj);
  const dMes   = allEntries.filter(e => e.data && e.data.startsWith(mesStr));

  document.getElementById('stTodayInc').textContent = fmt(dHoje.reduce((s,e)=>s+(e.ganho||0),0));
  document.getElementById('stTodayExp').textContent = fmt(dHoje.reduce((s,e)=>s+(e.gasto||0),0));
  const mInc = dMes.reduce((s,e)=>s+(e.ganho||0),0);
  const mExp = dMes.reduce((s,e)=>s+(e.gasto||0),0);
  document.getElementById('stMonthInc').textContent = fmt(mInc);
  document.getElementById('stMonthKm').textContent  = dMes.reduce((s,e)=>s+(e.km||0),0).toLocaleString('pt-BR') + ' km';
  document.getElementById('heroNet').textContent    = fmt(mInc - mExp);
  document.getElementById('heroSub').textContent    = `${dMes.length} dia(s) registrado(s) este m√™s`;
}

window.setFiltro = (f, btn) => {
  filtroAtual = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderHistorico();
};

function renderHistorico() {
  const hj     = hoje();
  const mesStr = hj.slice(0,7);
  const semAgo = new Date(); semAgo.setDate(semAgo.getDate()-7);

  let lista = allEntries;
  if (filtroAtual === 'mes')    lista = allEntries.filter(e => e.data && e.data.startsWith(mesStr));
  if (filtroAtual === 'semana') lista = allEntries.filter(e => e.data && new Date(e.data+'T12:00:00') >= semAgo);

  const el = document.getElementById('histList');
  if (!lista.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">Nenhum registro encontrado</div></div>`;
    return;
  }
  el.innerHTML = lista.map(e => {
    const net = (e.ganho||0) - (e.gasto||0);
    const pos = net >= 0;
    const kmTag = e.km > 0 ? `<span class="tag">üõ£Ô∏è ${e.km} km</span>` : '';
    return `
    <div class="hist-item">
      <div>
        <div class="hi-date">${fmtDate(e.data)}</div>
        <div class="hi-net ${pos?'pos':'neg'}">${fmt(net)}</div>
        ${kmTag ? `<div class="hi-tags">${kmTag}</div>` : ''}
      </div>
      <div class="hi-right">
        <div class="hi-vals">
          <span style="color:var(--green)">+${fmt(e.ganho||0)}</span><br>
          <span style="color:var(--red)">-${fmt(e.gasto||0)}</span>
        </div>
        <button class="btn-del" onclick="excluir('${e.id}')" title="Excluir">üóë</button>
      </div>
    </div>`;
  }).join('');
}
</script>

</body>
</html>
